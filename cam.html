<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
		<script src="fontawesome-free-5.14.0-web/js/all.min.js"></script>
		<script src="jquery-3.3.1.slim.min.js"></script>
		<script src="bootstrap.min.js"></script>
		<title>Capture Portrait</title>
	</head>
	<body>
		<div class="container">
			<div class="jumbotron">
				<img class="rounded float-right" src="lol-logo.png" alt="Logo">
				<h1>Capture Patient Photo</h1>
				<p>Capture patient photo in portrait (3:4) format.</p>
			</div>
			<p><div id="errorMsg" class="alert alert-danger" style="display:none;"></div></p>
			<table id="camUI" style="display:none;">
				<tr>
					<!-- Stream video via webcam -->
					<td><video id="video" class="img-thumbnail" playsinline autoplay></video></td>
					<!-- Converted snapshot -->
					<td style="text-align:right;">Preview: </td>
					<td><canvas id="c2" class="img-thumbnail"></canvas></td>
				</tr>
				<tr>
					<!-- Trigger canvas web API -->
					<td style="text-align:center;"><button id="snap" class="btn btn-outline-secondary" style="display:none;" tabindex="1" data-togle="tooltip" title="Compose photo using viewfinder, then click here for preview"><i class="fas fa-camera-retro fa-2x"></i></button></td>
					<td>
						<div id="initials_div" style="visibility:hidden;">
						Enter Patient Initials:
						<input id="initials" type="text" maxlength="3" width="4" oninput="show_save(this);" tabindex="2" data-toggle="tooltip" title="Enter patient initials">
						</div>
					</td>
					<td style="text-align:center;"><a id="save" class="btn btn-outline-primary" download="" href="" onclick="download_img(this);" style="display:none;" tabindex="3" data-toggle="tooltip" title="Click here to save preview"><i class="fas fa-portrait fa-2x"></i></a></td>
				</tr>
			</table>
				<p><div id="fileSaved" class="alert alert-success alert-dismissible" style="display:none;">
					<button type="button" class="close" data-dismiss="alert">&times;</button>
					<strong>Success!</strong> Preview has been saved successfully.
				</div></p>
				<p><div id="fileName" class="alert alert-info" style="display:none;"></div></p>

			<!-- Webcam video snapshot -->
			<div id="notShown">
				<canvas id="canvas"></canvas>
			</div>
		</div>

		<script>
			$(document).ready(function(){
				$('[data-toggle="tooltip"]').tooltip();
			});
			// Grab elements, create settings, etc.
			var video = document.getElementById('video');
			// Elements for taking the snapshot
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');
			var video = document.getElementById('video');
			var canvas2 = document.getElementById('c2');
			var c2 = canvas2.getContext('2d');
			var initials_div = document.getElementById('initials_div');
			var sv = document.getElementById('save');
			var fileName = document.getElementById('fileName');
			var file_ext="jpg";
			var file_desc="image/jpeg";
			var cam_width=640;
			var cam_height=480;
			var save_width=(cam_height / 4) * 3;
			//var notShown = document.getElementById('notShown');
			//notShown.style.display = "none";
			canvas.style.display = "none";
			// Get access to the camera!
			if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: {width: cam_width, height: cam_height}}).then(function(stream) {
					video.srcObject = stream;
					video.play();
					video.width = cam_width;
					video.height = cam_height;
					canvas.width = cam_width;
					canvas.height = cam_height;
					canvas2.width = save_width;
					canvas2.height = cam_height;
					document.getElementById("snap").style.display="";
					document.getElementById("camUI").style.display="";
					document.getElementById("snap").focus();
				})
				.catch(function(err) {
					document.getElementById("errorMsg").style.display = "";
					document.getElementById("errorMsg").innerHTML = "<h2>Error!</h2> <br>Could not connect to webcam. {" + err + "}";
				});
			}

			// Trigger photo take
			document.getElementById("snap").addEventListener("click", function() {
				// Capture the image at a known resolution...
				// This routine scales the ENTIRE frame at requested resolution
				// Thus if aspect ratio is not 4:3, then image gets distorted!
				context.drawImage(video, 0, 0, cam_width, cam_height);
				// Crop the image to desired resolution from above...
				// This routine DOES NOT scale, it just crops, so no distortion!!!
				c2.drawImage(canvas, ((cam_width - save_width) / 2), 0, save_width, cam_height, 0, 0, save_width, cam_height);
				initials_div.style.visibility = "visible";
				document.getElementById('initials').focus();
			});

			// Download the image...
			download_img = function(el) {
				var dt = new Date();
				var yr = (dt.getFullYear() * 10000) + ((dt.getMonth() + 1) * 100) + dt.getDate();
				var initials = document.getElementById('initials');
				el.download = save_as();
				var imageURI = canvas2.toDataURL(file_desc);
				el.href = imageURI;
				document.getElementById("fileSaved").style.display="";
			};

			// Show the Save As link...
			show_save = function(el) {
				var dt = new Date();
				var yr = (dt.getFullYear() * 10000) + ((dt.getMonth() + 1) * 100) + dt.getDate();
				sv.style.display = "";
				fileName.style.display = "";
				fileName.innerHTML = "File to be saved as \"" + save_as() + "\"";
				// Disconnect the callback...
			};
			
			function save_as() {
				var dt = new Date();
				var yr = (dt.getFullYear() * 10000) + ((dt.getMonth() + 1) * 100) + dt.getDate();
				var initials = document.getElementById('initials');
				return (yr + "-patPhoto-" + initials.value + "." + file_ext);
			}
		</script>
	</body>
</html>